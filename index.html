<!DOCTYPE html>
<html>
<head>
    <title>Adventures in New Arvandal</title>
    <link rel="stylesheet" href="webpage/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container" style="padding:0;height:100vh;">
    <div class="row" style="align-items:start;height:100vh;">
      <div class="col-2 nav-wrapper" style="width:auto;min-width:100px;max-width:110px;flex-basis:20%;padding:0;height:100vh;">
        <div class="navigation" style="width:110px;min-width:90px;height:100vh;">
          <ul style="margin:0;padding:0;margin:10px 0 0 0;text-align:left;border:none;">
            <li><button class="btn" style="text-align:left;width:100%;" onclick="setContentPage('/vault/database/game_rules.md')">Rules</button></li>
            <li><button class="btn" style="text-align:left;width:100%;" onclick="setContentPage('/vault/database/spells.md')">Spells</button></li>
            <li><button class="btn" style="text-align:left;width:100%;" onclick="setContentPage('/vault/database/wildshapes.md')">Wildshapes</button></li>
            <li><button class="btn" style="text-align:left;width:100%;" onclick="setContentPage('/vault/database/alchemy.md')">Alchemy</button></li>
          </ul>
          <ul style="margin:0;padding:0;margin-top:10px;text-align:left;border:none;">
            <li><button class="btn" style="text-align:left;width:100%;" onclick="setContentPage('/vault/database/characters/ayra.md')">Ayra</button></li>
            <li><button class="btn" style="text-align:left;width:100%;" onclick="setContentPage('/vault/database/characters/kal.md')">Kal</button></li>
            <li><button class="btn" style="text-align:left;width:100%;" onclick="setContentPage('/vault/database/characters/kazimir.md')">Kazimir</button></li>
            <li><button class="btn" style="text-align:left;width:100%;" onclick="setContentPage('/vault/database/characters/mufi.md')">Mutafa'il</button></li>
            <li><button class="btn" style="text-align:left;width:100%;" onclick="setContentPage('/vault/database/characters/nyari.md')">Nyari</button></li>
          </ul>
        </div>
      </div>
      <div class="col-2 dndcontent" style="width:auto;min-width:100px;flex-basis:60%;"></div>

      <div class="col-2 nav-wrapper" style="width:auto;min-width:100px;flex-basis:20%;padding:0;height:100vh;">
        <div class="navigation dndindex" style="width:auto;min-width:100px;flex-basis:20%;"></div>
      </div>
    </div>
  </div>
    
  <script src="tools/json_parser.js"></script>
  <script src="tools/md_parser.js"></script>
  <script>
    function setNavPosition()
    {
      const navigationDivs = document.querySelectorAll('.navigation'); 
      navigationDivs.forEach((navigation) => {
        const wrapperRect = navigation.parentElement.getBoundingClientRect();
        {
          let computedStyle = window.getComputedStyle(navigation);
          let minWidth = parseFloat(computedStyle.getPropertyValue('min-width')) + 0.1;
          let currentWidth = parseFloat(computedStyle.getPropertyValue('width'));
          var hasSpaceNextToContent = currentWidth > minWidth && parseFloat(window.innerWidth) > 600;
        }

        navigation.style.width = `${wrapperRect.width}px`;

        if (window.scrollY > 0 && hasSpaceNextToContent ) 
        {
          navigation.style.position = 'fixed';
          navigation.style.top = 0;
          navigation.style.left = `${wrapperRect.left}px`;
        } 
        else 
        {
          navigation.style.position = 'relative';
          navigation.style.top = '0px';
          navigation.style.left = '0px';
        }
      });
    }

//////////////////////////////////////////////////
//////////////////////////////////////////////////
//////////////////////////////////////////////////
/// INDEXING
//////////////////////////////////////////////////
//////////////////////////////////////////////////
//////////////////////////////////////////////////

    class TreeNode {
      constructor(value){
        this.name = value ? value.innerText : "";
        this.element = value;
        this.parent = null;
        this.children = [];
      }
      addChild(childNode) {
        this.children.push(childNode);
        childNode.parent = this;
      }
    }
    var rootNode = new TreeNode(null);
  
    function addTreeNodeToIndexView(treeNode, parentElement)
    {  
      parentElement.innerHTML = (treeNode.children.length > 0 ? '- ' : '') + treeNode.name.replace(/^.*(\/[a-zA-Z_0-9]+.md)$/g,'$1');
      if (treeNode.children.length > 0)
      {
        const unorderedList = document.createElement('ul');

        unorderedList.onclick = function(e){
          e.target.classList.toggle('collapsed');
          if (e.target.innerHTML[0] === '+' || e.target.innerHTML[0] === '-')
          {
            let char = e.target.innerHTML[0] === '+' ? '-' : '+';
            e.target.innerHTML = char + e.target.innerHTML.slice(1);

            e.stopPropagation();
          }
        };

        treeNode.children.forEach(childNode => {
          const listItem = document.createElement('li');
          
          // Set Link
          if (childNode.children.length === 0)
          {
            const a = document.createElement('a');
            a.href = `#${childNode.name.replace(/\s/g, '_')}`;
            listItem.appendChild(a);            
            addTreeNodeToIndexView(childNode, a);
          }
          else
          {
            addTreeNodeToIndexView(childNode, listItem);
          }

          unorderedList.appendChild(listItem);
        });
        parentElement.appendChild(unorderedList);
        //unorderedList.style.zIndex = parentElement.style.zIndex + 1;
      }
    }

    function getHeaderElementDepth(element)
    {
      return element && element.localName && element.localName.startsWith('h') && element.localName <= 'h6' ? element.localName : '';
    }

    function generateIndexTree(rootTreeNode, content)
    {
      let element = content.firstChild;
      let previousDepth = '';
      let parentNode = rootTreeNode;
      while(element)
      {
        let currentDepth = getHeaderElementDepth(element);

        if (currentDepth !== '')
        {
          // backtrack until we find a lower numbered header
          while(currentDepth <= getHeaderElementDepth(parentNode.element))
          {
            parentNode = parentNode.parent;
          }
          
          let childNode = new TreeNode(element);
          parentNode.addChild(childNode);
          parentNode = childNode;          
        }
        element = element.nextElementSibling;
      }
    }

    function getIndexedContentPage(name) { return rootNode.children.find(node => node.name === name); }

    function indexContent(parentNode, name, content)
    {
      let exists = getIndexedContentPage(name);

      if (!getIndexedContentPage(name))
      {
        let newNode = new TreeNode(null);
        newNode.parent = parentNode;
        newNode.name = name;
        parentNode.addChild(newNode);

        generateIndexTree(newNode, content);
      }
    }

    async function fetchMd(relativeMdUrl)
    {
      console.log('fetch & cache: ' + relativeMdUrl);

      let div = null;
      await fetchMdAsHtml(relativeMdUrl)
      .then(data => {
        div = document.createElement('div');
        div.innerHTML = data;
        indexContent(rootNode, relativeMdUrl, div);
      });
      
      return div;
    }
    
    function applyNodeToView(node)
    {
      const contentHolder = document.querySelector('.dndcontent');
      contentHolder.innerHTML = node.element.outerHTML;
          
      let index = document.querySelector('.dndindex');
      index.innerHTML = '';
      addTreeNodeToIndexView(node, index);
    }

    function applyCustomDivToView(div)
    {      
      let dummyNode = new TreeNode(null);
      dummyNode.element = div;
      generateIndexTree(dummyNode, div);
      applyNodeToView(dummyNode);
    }

    function setContentPage(relativeMdUrl)
    {
      let contentNode = getIndexedContentPage(relativeMdUrl);

      if (contentNode)
      {
        applyNodeToView(contentNode);
      }
      else
      {
        fetchMd(relativeMdUrl).then((div) => {
          let contentNode = getIndexedContentPage(relativeMdUrl);
          if (contentNode)
          {
            contentNode.element = div;
          }
          else
          {
            console.log("huh 1");
          }
        }).then(() => {
          let contentNode = getIndexedContentPage(relativeMdUrl);
          if (contentNode)
          {
            applyNodeToView(contentNode);
          }
          else
          {
            console.log("huh 2");
          }
        });
      }
    }
 
    // EXECUTION
    {
      const urlParams = new URLSearchParams(window.location.search);

      let contentPageUrl = '/vault/database/game_rules.md';
      for (const [key, value] of urlParams)
      {
        if (key === 'page')
        {
          contentPageUrl = `/vault/database/${value}.md`
        }
      }

      setContentPage(contentPageUrl);
      
      window.addEventListener('paste', (event) => {
        try 
        {
          let result = convert5EJsonToText(event.clipboardData.getData('text'));
          let div = document.createElement('div');
          div.innerHTML = result;
          applyCustomDivToView(div);
        }
        catch (error) 
        {
          console.log(error);
          return;
        }

        event.preventDefault();
      }); 

      // let index = document.querySelector('.dndindex');
      // // console.log(index);
      // index.onclick = function() {
      //   console.log('test');
      // };
      
     

      window.addEventListener('scroll', setNavPosition);
      // window.addEventListener('scroll', (e) => {
      //   const x = event.clientX || 0;
      //   const y = event.clientY || 0;

      //   const hoveredElement = document.elementFromPoint(x,y);

      //   //console.log(event);
      //  // console.log(`${x} -- ${y}`);
      //   event.stopPropagation();
      // });

      window.addEventListener('resize', setNavPosition);
      window.addEventListener('load', () => 
      {
          const navigation = document.querySelector('.navigation');
          navigation.style.top = '0px';
      });
    }
  </script>

</body>
</html>